stages:
  - build
  - quality
  - security
  - docker

variables:
  SONAR_PROJECT_KEY: "free-chat"
  DOCKER_IMAGE: "$DOCKER_USERNAME/free-chat"
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

# ------------------------------------------------
# BUILD (Compile + Package)
# ------------------------------------------------
build:
  stage: build
  image: maven:3.9-eclipse-temurin-17
  script:
    - cd backend
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - backend/target
    expire_in: 1 hour

# ------------------------------------------------
# SONARQUBE QUALITY GATE
# ------------------------------------------------
sonarqube:
  stage: quality
  image: maven:3.9-eclipse-temurin-17
  dependencies:
    - build
  script:
    - cd backend
    - >
      mvn sonar:sonar
      -Dsonar.projectKey=$SONAR_PROJECT_KEY
      -Dsonar.host.url=$SONAR_URL
      -Dsonar.login=$SONAR_TOKEN
      -Dsonar.java.binaries=target/classes
  allow_failure: false

# ------------------------------------------------
# TRIVY SECURITY SCAN (SOURCE CODE)
# ------------------------------------------------
trivy_scan:
  stage: security
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  script:
    - trivy fs . --severity HIGH,CRITICAL --format json --output trivy-report.json
  artifacts:
    when: always
    paths:
      - trivy-report.json
    expire_in: 7 days


# ------------------------------------------------
# DOCKER BUILD & PUSH (ONLY IF ABOVE PASSES)
# ------------------------------------------------
docker_build_push:
  stage: docker
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - echo "$DOCKER_TOKEN" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker build -t $DOCKER_IMAGE:latest ./backend
    - docker push $DOCKER_IMAGE:latest
